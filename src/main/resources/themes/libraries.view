<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content=""/>
    <meta content="tinystruct 2.0 (http://tinystruct.org)" name="generator"/>
    <title>Small Talk - Libraries</title>
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet"/>
    <!-- Bootstrap core CSS -->
    <link href="/scripts/bootstrap/bootstrap.min.css?raw=true" rel="stylesheet"/>

    <!-- Custom styles for this template -->
    <style type="text/css">
        body {
            padding-top: 40px;
            padding-bottom: 40px;
            background-color: #f5f5f5;
        }

        .libraries-container {
            margin-top: 50px;
        }

        .document-card {
            margin-bottom: 20px;
        }

        .document-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .document-description {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .document-meta {
            font-size: 0.8em;
            color: #999;
        }

        .nav-tabs {
            margin-bottom: 20px;
        }

        .back-link {
            margin-bottom: 20px;
        }
    </style>
</head>

<body>

<div class="container">
    <div class="libraries-container">
        <div class="row">
            <div class="col-md-12">
                <h1>Document Libraries</h1>
                <p>Browse and search documents uploaded by users.</p>
                
                <div class="back-link">
                    <a href="/?q=talk" class="btn btn-default"><i class="fas fa-arrow-left"></i> Back to Chat</a>
                </div>
                
                <ul class="nav nav-tabs" id="libraryTabs">
                    <li class="active"><a href="#myDocuments" data-toggle="tab">My Documents</a></li>
                    <li><a href="#publicDocuments" data-toggle="tab">Public Documents</a></li>
                    <li id="adminTab" style="display: none;"><a href="#allDocuments" data-toggle="tab">All Documents (Admin)</a></li>
                </ul>
                
                <div class="tab-content">
                    <!-- My Documents Tab -->
                    <div class="tab-pane active" id="myDocuments">
                        <div class="row" id="myDocumentsList">
                            <div class="col-md-12">
                                <p class="text-center" id="myDocumentsLoading">Loading your documents...</p>
                                <p class="text-center" id="myDocumentsEmpty" style="display: none;">You haven't uploaded any documents yet.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Public Documents Tab -->
                    <div class="tab-pane" id="publicDocuments">
                        <div class="row" id="publicDocumentsList">
                            <div class="col-md-12">
                                <p class="text-center" id="publicDocumentsLoading">Loading public documents...</p>
                                <p class="text-center" id="publicDocumentsEmpty" style="display: none;">No public documents available.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- All Documents Tab (Admin Only) -->
                    <div class="tab-pane" id="allDocuments">
                        <div class="row" id="allDocumentsList">
                            <div class="col-md-12">
                                <p class="text-center" id="allDocumentsLoading">Loading all documents...</p>
                                <p class="text-center" id="allDocumentsEmpty" style="display: none;">No documents available.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript" src="/scripts/jquery-1.11.3.min.js?raw=true"></script>
<script type="text/javascript" src="/scripts/bootstrap/bootstrap.min.js?raw=true"></script>
<script type="text/javascript">
    $(document).ready(function() {
        // Check if user is admin
        $.ajax({
            url: '/?q=auth/profile',
            type: 'GET',
            dataType: 'json',
            success: function(response) {
                if (response.isAdmin) {
                    $('#adminTab').show();
                }
                
                // Load documents
                loadMyDocuments();
                loadPublicDocuments();
                if (response.isAdmin) {
                    loadAllDocuments();
                }
            },
            error: function() {
                // Redirect to login if not authenticated
                window.location.href = '/?q=login';
            }
        });
        
        // Load user's documents
        function loadMyDocuments() {
            $.ajax({
                url: '/?q=libraries/my-documents',
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    $('#myDocumentsLoading').hide();
                    
                    if (response.length === 0) {
                        $('#myDocumentsEmpty').show();
                    } else {
                        renderDocuments(response, 'myDocumentsList');
                    }
                },
                error: function() {
                    $('#myDocumentsLoading').hide();
                    $('#myDocumentsList').html('<div class="col-md-12"><p class="text-danger">Error loading documents. Please try again later.</p></div>');
                }
            });
        }
        
        // Load public documents
        function loadPublicDocuments() {
            $.ajax({
                url: '/?q=libraries/public-documents',
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    $('#publicDocumentsLoading').hide();
                    
                    if (response.length === 0) {
                        $('#publicDocumentsEmpty').show();
                    } else {
                        renderDocuments(response, 'publicDocumentsList');
                    }
                },
                error: function() {
                    $('#publicDocumentsLoading').hide();
                    $('#publicDocumentsList').html('<div class="col-md-12"><p class="text-danger">Error loading documents. Please try again later.</p></div>');
                }
            });
        }
        
        // Load all documents (admin only)
        function loadAllDocuments() {
            $.ajax({
                url: '/?q=libraries/all-documents',
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    $('#allDocumentsLoading').hide();
                    
                    if (response.length === 0) {
                        $('#allDocumentsEmpty').show();
                    } else {
                        renderDocuments(response, 'allDocumentsList');
                    }
                },
                error: function() {
                    $('#allDocumentsLoading').hide();
                    $('#allDocumentsList').html('<div class="col-md-12"><p class="text-danger">Error loading documents. Please try again later.</p></div>');
                }
            });
        }
        
        // Render documents to the specified container
        function renderDocuments(documents, containerId) {
            var container = $('#' + containerId);
            container.empty();
            
            // Group documents by document ID
            var documentGroups = {};
            documents.forEach(function(doc) {
                if (!documentGroups[doc.documentId]) {
                    documentGroups[doc.documentId] = [];
                }
                documentGroups[doc.documentId].push(doc);
            });
            
            // Render each document group
            Object.keys(documentGroups).forEach(function(documentId) {
                var docs = documentGroups[documentId];
                var firstDoc = docs[0];
                
                var col = $('<div class="col-md-4"></div>');
                var card = $('<div class="panel panel-default document-card"></div>');
                var cardBody = $('<div class="panel-body"></div>');
                
                cardBody.append('<h4 class="document-title">' + firstDoc.title + '</h4>');
                cardBody.append('<p class="document-description">' + firstDoc.description + '</p>');
                cardBody.append('<p class="document-meta">Uploaded: ' + new Date(firstDoc.createdAt).toLocaleString() + '</p>');
                cardBody.append('<p class="document-meta">File: ' + firstDoc.filePath.split('/').pop() + '</p>');
                cardBody.append('<p class="document-meta">Fragments: ' + docs.length + '</p>');
                
                var viewBtn = $('<a href="/?q=talk&document=' + documentId + '" class="btn btn-primary btn-sm">Chat with Document</a>');
                cardBody.append(viewBtn);
                
                card.append(cardBody);
                col.append(card);
                container.append(col);
            });
        }
    });
</script>
</body>
</html>
